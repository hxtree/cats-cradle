"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Collection = void 0;
const Dice_1 = require("./Dice");
const NotationCodec_1 = require("./NotationCodec");
/**
 * A Collection holds same sided Dice and can be configured to modify or multiply the Dice outcome.
 */
class Collection {
    // Sides should be a Dice object
    constructor(amount, sides, modifier = 0, multiplier = 1) {
        this._dice = [];
        if (amount === undefined) {
            throw new RangeError('A collection must have at least one dice.');
        }
        for (let i = 1; i <= amount; i++) {
            this._dice.push(new Dice_1.Dice(sides));
        }
        this._sides = sides;
        this._modifier = modifier;
        this._multiplier = multiplier;
        this._excess = 0;
    }
    allocateBonuses(amount) {
        this._dice.forEach((dice) => {
            amount = dice.allocateBonuses(amount);
        });
        return amount;
    }
    set modifier(value) {
        this._modifier = value;
    }
    get modifier() {
        return this._modifier;
    }
    set multiplier(value) {
        this._multiplier = value;
    }
    get multiplier() {
        return this._multiplier;
    }
    get sides() {
        return this._sides;
    }
    get dice() {
        return this._dice;
    }
    set dice(value) {
        this._dice = value;
    }
    get value() {
        let value = 0;
        for (const dice of this._dice) {
            if (dice.value === undefined) {
                continue;
            }
            value += dice.value;
        }
        return (value + this._modifier) * this._multiplier;
    }
    get bonus() {
        let bonus = 0;
        for (const dice of this._dice) {
            if (dice.bonus === undefined) {
                continue;
            }
            bonus += dice.bonus;
        }
        return bonus;
    }
    set bonus(value) {
        this._dice = this._shuffle(this._dice);
        // do while seems to make more sense here
        this._dice.forEach(function (part, index, dice) {
            if (value === 0) {
                dice[index].bonus = 0;
            }
            if (dice[index].value === undefined) {
                throw new RangeError('A bonus cannot only be applied to a rolled dice.');
            }
            const bonus = dice[index].max - dice[index].value;
            dice[index].bonus = bonus;
            if (value > bonus) {
                value -= bonus;
            }
            else {
                value = 0;
            }
        });
        this._excess = value;
    }
    get totalNatural() {
        let total = 0;
        this._dice.forEach(function (part, index, dice) {
            total += dice[index].total;
        });
        return total;
    }
    get total() {
        return (this.totalNatural + this.modifier) * this.multiplier;
    }
    get excess() {
        return this._excess;
    }
    get notation() {
        const notationCodec = new NotationCodec_1.NotationCodec();
        return notationCodec.encodeCollection(this);
    }
    get minOutcome() {
        return this.count();
    }
    get maxOutcome() {
        return this.count() * this._sides;
    }
    get minPotential() {
        return (this.minOutcome + this.modifier) * this.multiplier;
    }
    get maxPotential() {
        return (this.maxOutcome + this.modifier) * this.multiplier;
    }
    get outcomePercent() {
        return (this.value - this.count()) / (this.maxOutcome - this.count());
    }
    count() {
        return this._dice.length;
    }
    roll() {
        this._dice.forEach(function (part, index, dice) {
            dice[index].roll();
        });
        return this.total;
    }
    _shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }
}
exports.Collection = Collection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL0NvbGxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsaUNBQThCO0FBQzlCLG1EQUFnRDtBQTJCaEQ7O0dBRUc7QUFDSCxNQUFhLFVBQVU7SUFZbkIsZ0NBQWdDO0lBQ2hDLFlBQW1CLE1BQWMsRUFBRSxLQUFhLEVBQUUsV0FBbUIsQ0FBQyxFQUFFLGFBQXFCLENBQUM7UUFadEYsVUFBSyxHQUFnQixFQUFFLENBQUM7UUFhNUIsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFO1lBQ3RCLE1BQU0sSUFBSSxVQUFVLENBQUMsMkNBQTJDLENBQUMsQ0FBQztTQUNyRTtRQUVELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxXQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUNwQztRQUVELElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1FBQzFCLElBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDO1FBQzlCLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO0lBQ3JCLENBQUM7SUFFTSxlQUFlLENBQUMsTUFBYztRQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQVUsRUFBRSxFQUFFO1lBQzlCLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVELElBQVcsUUFBUSxDQUFDLEtBQWE7UUFDN0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENB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S0FBSyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkIsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQUVPLFFBQVEsQ0FBQyxLQUFrQjtRQUMvQixJQUFJLFlBQVksR0FBRyxLQUFLLENBQUMsTUFBTSxFQUMzQixXQUFXLENBQUM7UUFDaEIsT0FBTyxZQUFZLEtBQUssQ0FBQyxFQUFFO1lBQ3ZCLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxZQUFZLENBQUMsQ0FBQztZQUN2RCxZQUFZLEVBQUUsQ0FBQztZQUNmLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxFQUFFLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1NBQ3pGO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztDQUNKO0FBdExELGdDQXNMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpY2UgfSBmcm9tICcuL0RpY2UnO1xuaW1wb3J0IHsgTm90YXRpb25Db2RlYyB9IGZyb20gJy4vTm90YXRpb25Db2RlYyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbGxlY3Rpb24ge1xuICAgIHNldCBtb2RpZmllcih2YWx1ZTogbnVtYmVyKTtcbiAgICBnZXQgbW9kaWZpZXIoKTogbnVtYmVyO1xuICAgIHNldCBtdWx0aXBsaWVyKHZhbHVlOiBudW1iZXIpO1xuICAgIGdldCBtdWx0aXBsaWVyKCk6IG51bWJlcjtcbiAgICBnZXQgc2lkZXMoKTogbnVtYmVyO1xuICAgIGdldCBkaWNlKCk6IEFycmF5PERpY2U+O1xuICAgIHNldCBkaWNlKHZhbHVlOiBBcnJheTxEaWNlPik7XG4gICAgZ2V0IHZhbHVlKCk6IG51bWJlciB8IHVuZGVmaW5lZDtcbiAgICBnZXQgYm9udXMoKTogbnVtYmVyO1xuICAgIHNldCBib251cyh2YWx1ZTogbnVtYmVyKTtcbiAgICBnZXQgdG90YWxOYXR1cmFsKCk6IG51bWJlcjtcbiAgICBnZXQgdG90YWwoKTogbnVtYmVyO1xuICAgIGdldCBleGNlc3MoKTogbnVtYmVyO1xuICAgIGdldCBub3RhdGlvbigpOiBzdHJpbmc7XG4gICAgZ2V0IG1pbk91dGNvbWUoKTogbnVtYmVyO1xuICAgIGdldCBtYXhPdXRjb21lKCk6IG51bWJlcjtcbiAgICBnZXQgbWluUG90ZW50aWFsKCk6IG51bWJlcjtcbiAgICBnZXQgbWF4UG90ZW50aWFsKCk6IG51bWJlcjtcbiAgICBnZXQgb3V0Y29tZVBlcmNlbnQoKTogbnVtYmVyO1xuICAgIGNvdW50KCk6IG51bWJlcjtcbiAgICByb2xsKCk6IG51bWJlcjtcbiAgICBhbGxvY2F0ZUJvbnVzZXMoYW1vdW50OiBudW1iZXIpOiBudW1iZXI7XG59XG5cbi8qKlxuICogQSBDb2xsZWN0aW9uIGhvbGRzIHNhbWUgc2lkZWQgRGljZSBhbmQgY2FuIGJlIGNvbmZpZ3VyZWQgdG8gbW9kaWZ5IG9yIG11bHRpcGx5IHRoZSBEaWNlIG91dGNvbWUuXG4gKi9cbmV4cG9ydCBjbGFzcyBDb2xsZWN0aW9uIGltcGxlbWVudHMgSUNvbGxlY3Rpb24ge1xuICAgIHByaXZhdGUgX2RpY2U6IEFycmF5PERpY2U+ID0gW107XG5cbiAgICBwcml2YXRlIF9zaWRlczogbnVtYmVyO1xuXG4gICAgcHJpdmF0ZSBfbW9kaWZpZXI6IG51bWJlcjtcblxuICAgIHByaXZhdGUgX211bHRpcGxpZXI6IG51bWJlcjtcblxuICAgIC8qKiBleGNlc3MgYm9udXMgYW1vdW50IHRoYXQgY291bGQgbm90IGJlIGFic29yYmVkIGJ5IGRpY2UgKi9cbiAgICBwcml2YXRlIF9leGNlc3M6IG51bWJlcjtcblxuICAgIC8vIFNpZGVzIHNob3VsZCBiZSBhIERpY2Ugb2JqZWN0XG4gICAgcHVibGljIGNvbnN0cnVjdG9yKGFtb3VudDogbnVtYmVyLCBzaWRlczogbnVtYmVyLCBtb2RpZmllcjogbnVtYmVyID0gMCwgbXVsdGlwbGllcjogbnVtYmVyID0gMSkge1xuICAgICAgICBpZiAoYW1vdW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBIGNvbGxlY3Rpb24gbXVzdCBoYXZlIGF0IGxlYXN0IG9uZSBkaWNlLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gYW1vdW50OyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuX2RpY2UucHVzaChuZXcgRGljZShzaWRlcykpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fc2lkZXMgPSBzaWRlcztcbiAgICAgICAgdGhpcy5fbW9kaWZpZXIgPSBtb2RpZmllcjtcbiAgICAgICAgdGhpcy5fbXVsdGlwbGllciA9IG11bHRpcGxpZXI7XG4gICAgICAgIHRoaXMuX2V4Y2VzcyA9IDA7XG4gICAgfVxuXG4gICAgcHVibGljIGFsbG9jYXRlQm9udXNlcyhhbW91bnQ6IG51bWJlcik6IG51bWJlciB7XG4gICAgICAgIHRoaXMuX2RpY2UuZm9yRWFjaCgoZGljZTogRGljZSkgPT4ge1xuICAgICAgICAgICAgYW1vdW50ID0gZGljZS5hbGxvY2F0ZUJvbnVzZXMoYW1vdW50KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBhbW91bnQ7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBtb2RpZmllcih2YWx1ZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuX21vZGlmaWVyID0gdmFsdWU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBtb2RpZmllcigpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fbW9kaWZpZXI7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBtdWx0aXBsaWVyKHZhbHVlOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5fbXVsdGlwbGllciA9IHZhbHVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgbXVsdGlwbGllcigpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fbXVsdGlwbGllcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHNpZGVzKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zaWRlcztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGRpY2UoKTogQXJyYXk8RGljZT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGljZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0IGRpY2UodmFsdWU6IEFycmF5PERpY2U+KSB7XG4gICAgICAgIHRoaXMuX2RpY2UgPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHZhbHVlKCk6IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gICAgICAgIGxldCB2YWx1ZSA9IDA7XG5cbiAgICAgICAgZm9yIChjb25zdCBkaWNlIG9mIHRoaXMuX2RpY2UpIHtcbiAgICAgICAgICAgIGlmIChkaWNlLnZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhbHVlICs9IGRpY2UudmFsdWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKHZhbHVlICsgdGhpcy5fbW9kaWZpZXIpICogdGhpcy5fbXVsdGlwbGllcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGJvbnVzKCk6IG51bWJlciB7XG4gICAgICAgIGxldCBib251cyA9IDA7XG5cbiAgICAgICAgZm9yIChjb25zdCBkaWNlIG9mIHRoaXMuX2RpY2UpIHtcbiAgICAgICAgICAgIGlmIChkaWNlLmJvbnVzID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJvbnVzICs9IGRpY2UuYm9udXM7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYm9udXM7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBib251cyh2YWx1ZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuX2RpY2UgPSB0aGlzLl9zaHVmZmxlKHRoaXMuX2RpY2UpO1xuXG4gICAgICAgIC8vIGRvIHdoaWxlIHNlZW1zIHRvIG1ha2UgbW9yZSBzZW5zZSBoZXJlXG4gICAgICAgIHRoaXMuX2RpY2UuZm9yRWFjaChmdW5jdGlvbiAocGFydDogRGljZSwgaW5kZXg6IG51bWJlciwgZGljZTogQXJyYXk8RGljZT4pIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGRpY2VbaW5kZXhdLmJvbnVzID0gMDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGRpY2VbaW5kZXhdLnZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQSBib251cyBjYW5ub3Qgb25seSBiZSBhcHBsaWVkIHRvIGEgcm9sbGVkIGRpY2UuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGJvbnVzID0gZGljZVtpbmRleF0ubWF4IC0gZGljZVtpbmRleF0udmFsdWUhO1xuXG4gICAgICAgICAgICBkaWNlW2luZGV4XS5ib251cyA9IGJvbnVzO1xuXG4gICAgICAgICAgICBpZiAodmFsdWUgPiBib251cykge1xuICAgICAgICAgICAgICAgIHZhbHVlIC09IGJvbnVzO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX2V4Y2VzcyA9IHZhbHVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgdG90YWxOYXR1cmFsKCk6IG51bWJlciB7XG4gICAgICAgIGxldCB0b3RhbCA9IDA7XG5cbiAgICAgICAgdGhpcy5fZGljZS5mb3JFYWNoKGZ1bmN0aW9uIChwYXJ0OiBEaWNlLCBpbmRleDogbnVtYmVyLCBkaWNlOiBBcnJheTxEaWNlPikge1xuICAgICAgICAgICAgdG90YWwgKz0gZGljZVtpbmRleF0udG90YWw7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0b3RhbDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHRvdGFsKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiAodGhpcy50b3RhbE5hdHVyYWwgKyB0aGlzLm1vZGlmaWVyKSAqIHRoaXMubXVsdGlwbGllcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGV4Y2VzcygpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXhjZXNzO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgbm90YXRpb24oKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3Qgbm90YXRpb25Db2RlYyA9IG5ldyBOb3RhdGlvbkNvZGVjKCk7XG4gICAgICAgIHJldHVybiBub3RhdGlvbkNvZGVjLmVuY29kZUNvbGxlY3Rpb24odGhpcyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBtaW5PdXRjb21lKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvdW50KCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBtYXhPdXRjb21lKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvdW50KCkgKiB0aGlzLl9zaWRlcztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG1pblBvdGVudGlhbCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gKHRoaXMubWluT3V0Y29tZSArIHRoaXMubW9kaWZpZXIpICogdGhpcy5tdWx0aXBsaWVyO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgbWF4UG90ZW50aWFsKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiAodGhpcy5tYXhPdXRjb21lICsgdGhpcy5tb2RpZmllcikgKiB0aGlzLm11bHRpcGxpZXI7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBvdXRjb21lUGVyY2VudCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gKHRoaXMudmFsdWUhIC0gdGhpcy5jb3VudCgpKSAvICh0aGlzLm1heE91dGNvbWUgLSB0aGlzLmNvdW50KCkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb3VudCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGljZS5sZW5ndGg7XG4gICAgfVxuXG4gICAgcHVibGljIHJvbGwoKTogbnVtYmVyIHtcbiAgICAgICAgdGhpcy5fZGljZS5mb3JFYWNoKGZ1bmN0aW9uIChwYXJ0OiBEaWNlLCBpbmRleDogbnVtYmVyLCBkaWNlOiBBcnJheTxEaWNlPikge1xuICAgICAgICAgICAgZGljZVtpbmRleF0ucm9sbCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy50b3RhbDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9zaHVmZmxlKGFycmF5OiBBcnJheTxEaWNlPikge1xuICAgICAgICBsZXQgY3VycmVudEluZGV4ID0gYXJyYXkubGVuZ3RoLFxuICAgICAgICAgICAgcmFuZG9tSW5kZXg7XG4gICAgICAgIHdoaWxlIChjdXJyZW50SW5kZXggIT09IDApIHtcbiAgICAgICAgICAgIHJhbmRvbUluZGV4ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogY3VycmVudEluZGV4KTtcbiAgICAgICAgICAgIGN1cnJlbnRJbmRleC0tO1xuICAgICAgICAgICAgW2FycmF5W2N1cnJlbnRJbmRleF0sIGFycmF5W3JhbmRvbUluZGV4XV0gPSBbYXJyYXlbcmFuZG9tSW5kZXhdLCBhcnJheVtjdXJyZW50SW5kZXhdXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhcnJheTtcbiAgICB9XG59XG4iXX0=