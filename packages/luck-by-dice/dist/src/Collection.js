"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Collection = void 0;
const Dice_1 = require("./Dice");
const NotationCodec_1 = require("./NotationCodec");
/**
 * A Collection holds same sided Dice and can be configured to modify or multiply the Dice outcome.
 */
class Collection {
    // Sides should be a Dice object
    constructor(amount, sides, modifier = 0, multiplier = 1) {
        this._dice = [];
        if (amount === undefined) {
            throw new RangeError('A collection must have at least one dice.');
        }
        for (let i = 1; i <= amount; i++) {
            this._dice.push(new Dice_1.Dice(sides));
        }
        this._sides = sides;
        this._modifier = modifier;
        this._multiplier = multiplier;
        this._excess = 0;
    }
    allocateBonuses(amount) {
        this._dice.forEach((dice) => {
            amount = dice.allocateBonuses(amount);
        });
        return amount;
    }
    set modifier(value) {
        this._modifier = value;
    }
    get modifier() {
        return this._modifier;
    }
    set multiplier(value) {
        this._multiplier = value;
    }
    get multiplier() {
        return this._multiplier;
    }
    get sides() {
        return this._sides;
    }
    get dice() {
        return this._dice;
    }
    set dice(value) {
        this._dice = value;
    }
    get value() {
        let value = 0;
        for (const dice of this._dice) {
            if (dice.value === undefined) {
                continue;
            }
            value += dice.value;
        }
        return (value + this._modifier) * this._multiplier;
    }
    get bonus() {
        let bonus = 0;
        for (const dice of this._dice) {
            if (dice.bonus === undefined) {
                continue;
            }
            bonus += dice.bonus;
        }
        return bonus;
    }
    set bonus(value) {
        this._dice = this._shuffle(this._dice);
        // do while seems to make more sense here
        this._dice.forEach((part, index, dice) => {
            if (value === 0) {
                dice[index].bonus = 0;
            }
            if (dice[index].value === undefined) {
                throw new RangeError('A bonus cannot only be applied to a rolled dice.');
            }
            const bonus = dice[index].max - (dice[index].value ?? 0);
            dice[index].bonus = bonus;
            if (value > bonus) {
                value -= bonus;
            }
            else {
                value = 0;
            }
        });
        this._excess = value;
    }
    get totalNatural() {
        let total = 0;
        this._dice.forEach((part, index, dice) => {
            total += dice[index].total;
        });
        return total;
    }
    get total() {
        return (this.totalNatural + this.modifier) * this.multiplier;
    }
    get excess() {
        return this._excess;
    }
    get notation() {
        const notationCodec = new NotationCodec_1.NotationCodec();
        return notationCodec.encodeCollection(this);
    }
    get minOutcome() {
        return this.count();
    }
    get maxOutcome() {
        return this.count() * this._sides;
    }
    get minPotential() {
        return (this.minOutcome + this.modifier) * this.multiplier;
    }
    get maxPotential() {
        return (this.maxOutcome + this.modifier) * this.multiplier;
    }
    get outcomePercent() {
        if (this.value === undefined) {
            throw new Error('Dice must be rolled before an outcome percent can be computed');
        }
        return (this.value - this.count()) / (this.maxOutcome - this.count());
    }
    count() {
        return this._dice.length;
    }
    roll() {
        this._dice.forEach((part, index, dice) => {
            dice[index].roll();
        });
        return this.total;
    }
    _shuffle(array) {
        let currentIndex = array.length;
        let randomIndex;
        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [
                array[randomIndex],
                array[currentIndex],
            ];
        }
        return array;
    }
}
exports.Collection = Collection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Db2xsZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUE0QjtBQUM1QixtREFBOEM7QUEyQjlDOztHQUVHO0FBQ0gsTUFBYSxVQUFVO0lBWXJCLGdDQUFnQztJQUNoQyxZQUNFLE1BQWMsRUFDZCxLQUFhLEVBQ2IsV0FBbUIsQ0FBQyxFQUNwQixhQUFxQixDQUFDO1FBaEJoQixVQUFLLEdBQWdCLEVBQUUsQ0FBQztRQWtCOUIsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFO1lBQ3hCLE1BQU0sSUFBSSxVQUFVLENBQUMsMkNBQTJDLENBQUMsQ0FBQztTQUNuRTtRQUVELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDaEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxXQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUNsQztRQUVELElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1FBQzFCLElBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDO1FBQzlCLElBQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFFTSxlQUFlLENBQUMsTUFBYztRQUNuQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQVUsRUFBRSxFQUFFO1lBQ2hDLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVELElBQVcsUUFBUSxDQUFDLEtBQWE7UUFDL0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7SUFDekIsQ0FB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LENBQUMsTUFBTSxDQUFDO0lBQzNCLENBQUM7SUFFTSxJQUFJO1FBQ1QsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFVLEVBQUUsS0FBYSxFQUFFLElBQWlCLEVBQUUsRUFBRTtZQUNsRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVPLFFBQVEsQ0FBQyxLQUFrQjtRQUNqQyxJQUFJLFlBQVksR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQ2hDLElBQUksV0FBVyxDQUFDO1FBQ2hCLE9BQU8sWUFBWSxLQUFLLENBQUMsRUFBRTtZQUN6QixXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsWUFBWSxDQUFDLENBQUM7WUFDdkQsWUFBWSxFQUFFLENBQUM7WUFDZixDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsRUFBRSxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsR0FBRztnQkFDMUMsS0FBSyxDQUFDLFdBQVcsQ0FBQztnQkFDbEIsS0FBSyxDQUFDLFlBQVksQ0FBQzthQUNwQixDQUFDO1NBQ0g7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Q0FDRjtBQXJNRCxnQ0FxTUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RpY2V9IGZyb20gJy4vRGljZSc7XG5pbXBvcnQge05vdGF0aW9uQ29kZWN9IGZyb20gJy4vTm90YXRpb25Db2RlYyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNvbGxlY3Rpb24ge1xuICBzZXQgbW9kaWZpZXIodmFsdWU6IG51bWJlcik7XG4gIGdldCBtb2RpZmllcigpOiBudW1iZXI7XG4gIHNldCBtdWx0aXBsaWVyKHZhbHVlOiBudW1iZXIpO1xuICBnZXQgbXVsdGlwbGllcigpOiBudW1iZXI7XG4gIGdldCBzaWRlcygpOiBudW1iZXI7XG4gIGdldCBkaWNlKCk6IEFycmF5PERpY2U+O1xuICBzZXQgZGljZSh2YWx1ZTogQXJyYXk8RGljZT4pO1xuICBnZXQgdmFsdWUoKTogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICBnZXQgYm9udXMoKTogbnVtYmVyO1xuICBzZXQgYm9udXModmFsdWU6IG51bWJlcik7XG4gIGdldCB0b3RhbE5hdHVyYWwoKTogbnVtYmVyO1xuICBnZXQgdG90YWwoKTogbnVtYmVyO1xuICBnZXQgZXhjZXNzKCk6IG51bWJlcjtcbiAgZ2V0IG5vdGF0aW9uKCk6IHN0cmluZztcbiAgZ2V0IG1pbk91dGNvbWUoKTogbnVtYmVyO1xuICBnZXQgbWF4T3V0Y29tZSgpOiBudW1iZXI7XG4gIGdldCBtaW5Qb3RlbnRpYWwoKTogbnVtYmVyO1xuICBnZXQgbWF4UG90ZW50aWFsKCk6IG51bWJlcjtcbiAgZ2V0IG91dGNvbWVQZXJjZW50KCk6IG51bWJlcjtcbiAgY291bnQoKTogbnVtYmVyO1xuICByb2xsKCk6IG51bWJlcjtcbiAgYWxsb2NhdGVCb251c2VzKGFtb3VudDogbnVtYmVyKTogbnVtYmVyO1xufVxuXG4vKipcbiAqIEEgQ29sbGVjdGlvbiBob2xkcyBzYW1lIHNpZGVkIERpY2UgYW5kIGNhbiBiZSBjb25maWd1cmVkIHRvIG1vZGlmeSBvciBtdWx0aXBseSB0aGUgRGljZSBvdXRjb21lLlxuICovXG5leHBvcnQgY2xhc3MgQ29sbGVjdGlvbiBpbXBsZW1lbnRzIElDb2xsZWN0aW9uIHtcbiAgcHJpdmF0ZSBfZGljZTogQXJyYXk8RGljZT4gPSBbXTtcblxuICBwcml2YXRlIF9zaWRlczogbnVtYmVyO1xuXG4gIHByaXZhdGUgX21vZGlmaWVyOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBfbXVsdGlwbGllcjogbnVtYmVyO1xuXG4gIC8qKiBleGNlc3MgYm9udXMgYW1vdW50IHRoYXQgY291bGQgbm90IGJlIGFic29yYmVkIGJ5IGRpY2UgKi9cbiAgcHJpdmF0ZSBfZXhjZXNzOiBudW1iZXI7XG5cbiAgLy8gU2lkZXMgc2hvdWxkIGJlIGEgRGljZSBvYmplY3RcbiAgcHVibGljIGNvbnN0cnVjdG9yKFxuICAgIGFtb3VudDogbnVtYmVyLFxuICAgIHNpZGVzOiBudW1iZXIsXG4gICAgbW9kaWZpZXI6IG51bWJlciA9IDAsXG4gICAgbXVsdGlwbGllcjogbnVtYmVyID0gMSxcbiAgKSB7XG4gICAgaWYgKGFtb3VudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQSBjb2xsZWN0aW9uIG11c3QgaGF2ZSBhdCBsZWFzdCBvbmUgZGljZS4nKTtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBhbW91bnQ7IGkrKykge1xuICAgICAgdGhpcy5fZGljZS5wdXNoKG5ldyBEaWNlKHNpZGVzKSk7XG4gICAgfVxuXG4gICAgdGhpcy5fc2lkZXMgPSBzaWRlcztcbiAgICB0aGlzLl9tb2RpZmllciA9IG1vZGlmaWVyO1xuICAgIHRoaXMuX211bHRpcGxpZXIgPSBtdWx0aXBsaWVyO1xuICAgIHRoaXMuX2V4Y2VzcyA9IDA7XG4gIH1cblxuICBwdWJsaWMgYWxsb2NhdGVCb251c2VzKGFtb3VudDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICB0aGlzLl9kaWNlLmZvckVhY2goKGRpY2U6IERpY2UpID0+IHtcbiAgICAgIGFtb3VudCA9IGRpY2UuYWxsb2NhdGVCb251c2VzKGFtb3VudCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGFtb3VudDtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgbW9kaWZpZXIodmFsdWU6IG51bWJlcikge1xuICAgIHRoaXMuX21vZGlmaWVyID0gdmFsdWU7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG1vZGlmaWVyKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX21vZGlmaWVyO1xuICB9XG5cbiAgcHVibGljIHNldCBtdWx0aXBsaWVyKHZhbHVlOiBudW1iZXIpIHtcbiAgICB0aGlzLl9tdWx0aXBsaWVyID0gdmFsdWU7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG11bHRpcGxpZXIoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fbXVsdGlwbGllcjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc2lkZXMoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fc2lkZXM7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGRpY2UoKTogQXJyYXk8RGljZT4ge1xuICAgIHJldHVybiB0aGlzLl9kaWNlO1xuICB9XG5cbiAgcHVibGljIHNldCBkaWNlKHZhbHVlOiBBcnJheTxEaWNlPikge1xuICAgIHRoaXMuX2RpY2UgPSB2YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdmFsdWUoKTogbnVtYmVyIHwgdW5kZWZpbmVkIHtcbiAgICBsZXQgdmFsdWUgPSAwO1xuXG4gICAgZm9yIChjb25zdCBkaWNlIG9mIHRoaXMuX2RpY2UpIHtcbiAgICAgIGlmIChkaWNlLnZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB2YWx1ZSArPSBkaWNlLnZhbHVlO1xuICAgIH1cblxuICAgIHJldHVybiAodmFsdWUgKyB0aGlzLl9tb2RpZmllcikgKiB0aGlzLl9tdWx0aXBsaWVyO1xuICB9XG5cbiAgcHVibGljIGdldCBib251cygpOiBudW1iZXIge1xuICAgIGxldCBib251cyA9IDA7XG5cbiAgICBmb3IgKGNvbnN0IGRpY2Ugb2YgdGhpcy5fZGljZSkge1xuICAgICAgaWYgKGRpY2UuYm9udXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGJvbnVzICs9IGRpY2UuYm9udXM7XG4gICAgfVxuXG4gICAgcmV0dXJuIGJvbnVzO1xuICB9XG5cbiAgcHVibGljIHNldCBib251cyh2YWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fZGljZSA9IHRoaXMuX3NodWZmbGUodGhpcy5fZGljZSk7XG5cbiAgICAvLyBkbyB3aGlsZSBzZWVtcyB0byBtYWtlIG1vcmUgc2Vuc2UgaGVyZVxuICAgIHRoaXMuX2RpY2UuZm9yRWFjaCgocGFydDogRGljZSwgaW5kZXg6IG51bWJlciwgZGljZTogQXJyYXk8RGljZT4pID0+IHtcbiAgICAgIGlmICh2YWx1ZSA9PT0gMCkge1xuICAgICAgICBkaWNlW2luZGV4XS5ib251cyA9IDA7XG4gICAgICB9XG5cbiAgICAgIGlmIChkaWNlW2luZGV4XS52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKFxuICAgICAgICAgICdBIGJvbnVzIGNhbm5vdCBvbmx5IGJlIGFwcGxpZWQgdG8gYSByb2xsZWQgZGljZS4nLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBib251cyA9IGRpY2VbaW5kZXhdLm1heCAtIChkaWNlW2luZGV4XS52YWx1ZSA/PyAwKTtcblxuICAgICAgZGljZVtpbmRleF0uYm9udXMgPSBib251cztcblxuICAgICAgaWYgKHZhbHVlID4gYm9udXMpIHtcbiAgICAgICAgdmFsdWUgLT0gYm9udXM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YWx1ZSA9IDA7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLl9leGNlc3MgPSB2YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdG90YWxOYXR1cmFsKCk6IG51bWJlciB7XG4gICAgbGV0IHRvdGFsID0gMDtcblxuICAgIHRoaXMuX2RpY2UuZm9yRWFjaCgocGFydDogRGljZSwgaW5kZXg6IG51bWJlciwgZGljZTogQXJyYXk8RGljZT4pID0+IHtcbiAgICAgIHRvdGFsICs9IGRpY2VbaW5kZXhdLnRvdGFsO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRvdGFsO1xuICB9XG5cbiAgcHVibGljIGdldCB0b3RhbCgpOiBudW1iZXIge1xuICAgIHJldHVybiAodGhpcy50b3RhbE5hdHVyYWwgKyB0aGlzLm1vZGlmaWVyKSAqIHRoaXMubXVsdGlwbGllcjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZXhjZXNzKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX2V4Y2VzcztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbm90YXRpb24oKTogc3RyaW5nIHtcbiAgICBjb25zdCBub3RhdGlvbkNvZGVjID0gbmV3IE5vdGF0aW9uQ29kZWMoKTtcbiAgICByZXR1cm4gbm90YXRpb25Db2RlYy5lbmNvZGVDb2xsZWN0aW9uKHRoaXMpO1xuICB9XG5cbiAgcHVibGljIGdldCBtaW5PdXRjb21lKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY291bnQoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbWF4T3V0Y29tZSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmNvdW50KCkgKiB0aGlzLl9zaWRlcztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbWluUG90ZW50aWFsKCk6IG51bWJlciB7XG4gICAgcmV0dXJuICh0aGlzLm1pbk91dGNvbWUgKyB0aGlzLm1vZGlmaWVyKSAqIHRoaXMubXVsdGlwbGllcjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbWF4UG90ZW50aWFsKCk6IG51bWJlciB7XG4gICAgcmV0dXJuICh0aGlzLm1heE91dGNvbWUgKyB0aGlzLm1vZGlmaWVyKSAqIHRoaXMubXVsdGlwbGllcjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgb3V0Y29tZVBlcmNlbnQoKTogbnVtYmVyIHtcbiAgICBpZiAodGhpcy52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdEaWNlIG11c3QgYmUgcm9sbGVkIGJlZm9yZSBhbiBvdXRjb21lIHBlcmNlbnQgY2FuIGJlIGNvbXB1dGVkJyxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiAodGhpcy52YWx1ZSAtIHRoaXMuY291bnQoKSkgLyAodGhpcy5tYXhPdXRjb21lIC0gdGhpcy5jb3VudCgpKTtcbiAgfVxuXG4gIHB1YmxpYyBjb3VudCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9kaWNlLmxlbmd0aDtcbiAgfVxuXG4gIHB1YmxpYyByb2xsKCk6IG51bWJlciB7XG4gICAgdGhpcy5fZGljZS5mb3JFYWNoKChwYXJ0OiBEaWNlLCBpbmRleDogbnVtYmVyLCBkaWNlOiBBcnJheTxEaWNlPikgPT4ge1xuICAgICAgZGljZVtpbmRleF0ucm9sbCgpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMudG90YWw7XG4gIH1cblxuICBwcml2YXRlIF9zaHVmZmxlKGFycmF5OiBBcnJheTxEaWNlPik6IEFycmF5PERpY2U+IHtcbiAgICBsZXQgY3VycmVudEluZGV4ID0gYXJyYXkubGVuZ3RoO1xuICAgIGxldCByYW5kb21JbmRleDtcbiAgICB3aGlsZSAoY3VycmVudEluZGV4ICE9PSAwKSB7XG4gICAgICByYW5kb21JbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGN1cnJlbnRJbmRleCk7XG4gICAgICBjdXJyZW50SW5kZXgtLTtcbiAgICAgIFthcnJheVtjdXJyZW50SW5kZXhdLCBhcnJheVtyYW5kb21JbmRleF1dID0gW1xuICAgICAgICBhcnJheVtyYW5kb21JbmRleF0sXG4gICAgICAgIGFycmF5W2N1cnJlbnRJbmRleF0sXG4gICAgICBdO1xuICAgIH1cblxuICAgIHJldHVybiBhcnJheTtcbiAgfVxufVxuIl19