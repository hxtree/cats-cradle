import { kebabCase, truncate } from 'lodash';
import { IsUUID, IsDateString } from '@cats-cradle/validation-schemas';

export abstract class BaseMessageDto {
  @IsUUID()
  public messageId: string;

  @IsDateString()
  public timestamp: string;

  /**
   * Get autogenerated SNS topic name
   * The name is prefixed by STAGE_NAME and contains the class name.
   * {@link https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/quotas-messages.html}
   * {@link https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/quotas-queues.html}
   */
  get topicName(): string {
    const stageName = (process.env.STAGE_NAME ?? 'default').toLowerCase();
    const className = this.constructor.name;
    const classNameKebabCase = kebabCase(className);
    let topicName = truncate(`${stageName}-${classNameKebabCase}`, {
      length: 256 - '-topic'.length,
      omission: '-topic',
      separator: '-',
    });
    if (!/-topic$/.test(topicName)) {
      topicName += '-topic';
    }

    return topicName;
  }

  /**
   * Get auto generated SQS queue name
   * The name is prefixed by STAGE_NAME and APP_NAME followed by the message name with a queue suffix
   * {@link https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/quotas-messages.html}
   * {@link https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/quotas-queues.html}
   */
  get queueName(): string {
    const stageName = (process.env.STAGE_NAME ?? 'default').toLowerCase();
    const appName = (process.env.APP_NAME ?? 'undefined').toLowerCase();
    const className = this.constructor.name;
    const classNameKebabCase = kebabCase(className);
    let queueName = truncate(`${stageName}-${appName}-${classNameKebabCase}`, {
      length: 80 - '-queue'.length,
      omission: '-queue',
      separator: '-',
    });
    if (!/-queue$/.test(queueName)) {
      queueName += '-queue';
    }

    return queueName;
  }

  /**
   * Get auto generated topicArn
   * {@link https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html}
   * {@link https://docs.aws.amazon.com/IAM/latest/APIReference/API_User.html}
   */
  get topicArn(): string {
    const region = process.env.AWS_REGION;
    const account = process.env.AWS_ACCOUNT_ID;
    const { topicName } = this;

    return `arn:aws:sns:${region}:${account}:${topicName}`;
  }
}
