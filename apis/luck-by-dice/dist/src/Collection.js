"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Collection = void 0;
const Dice_1 = require("./Dice");
const NotationCodec_1 = require("./NotationCodec");
/**
 * A Collection holds same sided Dice and can be configured to modify or multiply the Dice outcome.
 */
class Collection {
    // Sides should be a Dice object
    constructor(amount, sides, modifier = 0, multiplier = 1) {
        this._dice = [];
        if (amount === undefined) {
            throw new RangeError('A collection must have at least one dice.');
        }
        for (let i = 1; i <= amount; i++) {
            this._dice.push(new Dice_1.Dice(sides));
        }
        this._sides = sides;
        this._modifier = modifier;
        this._multiplier = multiplier;
        this._excess = 0;
    }
    allocateBonuses(amount) {
        this._dice.forEach((dice) => {
            amount = dice.allocateBonuses(amount);
        });
        return amount;
    }
    set modifier(value) {
        this._modifier = value;
    }
    get modifier() {
        return this._modifier;
    }
    set multiplier(value) {
        this._multiplier = value;
    }
    get multiplier() {
        return this._multiplier;
    }
    get sides() {
        return this._sides;
    }
    get dice() {
        return this._dice;
    }
    set dice(value) {
        this._dice = value;
    }
    get value() {
        let value = 0;
        for (const dice of this._dice) {
            if (dice.value === undefined) {
                continue;
            }
            value += dice.value;
        }
        return (value + this._modifier) * this._multiplier;
    }
    get bonus() {
        let bonus = 0;
        for (const dice of this._dice) {
            if (dice.bonus === undefined) {
                continue;
            }
            bonus += dice.bonus;
        }
        return bonus;
    }
    set bonus(value) {
        this._dice = this._shuffle(this._dice);
        // do while seems to make more sense here
        this._dice.forEach(function (part, index, dice) {
            if (value === 0) {
                dice[index].bonus = 0;
            }
            if (dice[index].value === undefined) {
                throw new RangeError('A bonus cannot only be applied to a rolled dice.');
            }
            const bonus = dice[index].max - (dice[index].value ?? 0);
            dice[index].bonus = bonus;
            if (value > bonus) {
                value -= bonus;
            }
            else {
                value = 0;
            }
        });
        this._excess = value;
    }
    get totalNatural() {
        let total = 0;
        this._dice.forEach(function (part, index, dice) {
            total += dice[index].total;
        });
        return total;
    }
    get total() {
        return (this.totalNatural + this.modifier) * this.multiplier;
    }
    get excess() {
        return this._excess;
    }
    get notation() {
        const notationCodec = new NotationCodec_1.NotationCodec();
        return notationCodec.encodeCollection(this);
    }
    get minOutcome() {
        return this.count();
    }
    get maxOutcome() {
        return this.count() * this._sides;
    }
    get minPotential() {
        return (this.minOutcome + this.modifier) * this.multiplier;
    }
    get maxPotential() {
        return (this.maxOutcome + this.modifier) * this.multiplier;
    }
    get outcomePercent() {
        if (this.value === undefined) {
            throw new Error('Dice must be rolled before an outcome percent can be computed');
        }
        return (this.value - this.count()) / (this.maxOutcome - this.count());
    }
    count() {
        return this._dice.length;
    }
    roll() {
        this._dice.forEach(function (part, index, dice) {
            dice[index].roll();
        });
        return this.total;
    }
    _shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }
}
exports.Collection = Collection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Db2xsZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUE4QjtBQUM5QixtREFBZ0Q7QUEyQmhEOztHQUVHO0FBQ0gsTUFBYSxVQUFVO0lBWW5CLGdDQUFnQztJQUNoQyxZQUFtQixNQUFjLEVBQUUsS0FBYSxFQUFFLFdBQW1CLENBQUMsRUFBRSxhQUFxQixDQUFDO1FBWnRGLFVBQUssR0FBZ0IsRUFBRSxDQUFDO1FBYTVCLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtZQUN0QixNQUFNLElBQUksVUFBVSxDQUFDLDJDQUEyQyxDQUFDLENBQUM7U0FDckU7UUFFRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksV0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7U0FDcEM7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztRQUMxQixJQUFJLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQztRQUM5QixJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQztJQUNyQixDQUFDO0lBRU0sZUFBZSxDQUFDLE1BQWM7UUFDakMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFVLEVBQUUsRUFBRTtZQUM5QixNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxJQUFXLFFBQVEsQ0FBQyxLQUFhO1FBQzdCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO0lBQzNCLENBQUM7SUFFRCxJQUFXLFFBQVE7UUFDZixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDMUIsQ0FBQztJQUVELElBQVcsVUFBVSxDQUFDLEtBQWE7UUFDL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQVcsVUFBVTtRQUNqQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDNUIsQ0FBQztJQUVELElBQVcsS0FBSztRQUNaLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBRUQsSUFBVyxJQUFJO1FBQ1gsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxJQUFXLElBQUksQ0FBQyxLQUFrQjtRQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUN2QixDQUFDO0lBRUQsSUFBVyxLQUFLO1FBQ1osSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBRWQsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQzNCLElBQUksSUFBSSxDQUFDLEtBQUssS0FBSyxTQUFTLEVBQUU7Z0JBQzFCLFNBQVM7YUFDWjtZQUNELEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDO1NBQ3ZCO1FBRUQsT0FBTyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUN2RCxDQUFDO0lBRUQsSUFBVyxLQUFLO1FBQ1osSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBRWQsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQzNCLElBQUksSUFBSSxDQUFDLEtBQUssS0FBSyxTQUFTLEVBQUU7Z0JBQzFCLFNBQVM7YUFDWjtZQUNELEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDO1NBQ3ZCO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVELElBQVcsS0FBSyxDQUFDLEtBQWE7UUFDMUIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV2Qyx5Q0FBeUM7UUFDekMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFVLEVBQUUsS0FBYSxFQUFFLElBQWlCO1lBQ3JFLElBQUksS0FBSyxLQUFLLENBQUMsRUFBRTtnQkFDYixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQzthQUN6QjtZQUVELElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssS0FBSyxTQUFTLEVBQUU7Z0JBQ2pDLE1BQU0sSUFBSSxVQUFVLENBQUMsa0RBQWtELENBQUMsQ0FBQzthQUM1RTtZQUVELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBRXpELElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1lBRTFCLElBQUksS0FBSyxHQUFHLEtBQUssRUFBRTtnQkFDZixLQUFLLElBQUksS0FBSyxDQUFDO2FBQ2xCO2lCQUFNO2dCQUNILEtBQUssR0FBRyxDQUFDLENBQUM7YUFDYjtRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7SUFDekIsQ0FBQztJQUVELElBQVcsWUFBWTtRQUNuQixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFFZCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQVUsRUFBRSxLQUFhLEVBQUUsSUFBaUI7WUFDckUsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsSUFBVyxLQUFLO1FBQ1osT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDakUsQ0FBQztJQUVELElBQVcsTUFBTTtRQUNiLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBVyxRQUFRO1FBQ2YsTUFBTSxhQUFhLEdBQUcsSUFBSSw2QkFBYSxFQUFFLENBQUM7UUFDMUMsT0FBTyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVELElBQVcsVUFBVTtRQUNqQixPQUFPLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBVyxVQUFVO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDdEMsQ0FBQztJQUVELElBQVcsWUFBWTtRQUNuQixPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUMvRCxDQUFDO0lBRUQsSUFBVyxZQUFZO1FBQ25CLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQy9ELENBQUM7SUFFRCxJQUFXLGNBQWM7UUFDckIsSUFBRyxJQUFJLENBQUMsS0FBSyxLQUFLLFNBQVMsRUFBQztZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLCtEQUErRCxDQUFDLENBQUE7U0FDbkY7UUFDRCxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDMUUsQ0FBQztJQUVNLEtBQUs7UUFDUixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO0lBQzdCLENBQUM7SUFFTSxJQUFJO1FBQ1AsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFVLEVBQUUsS0FBYSxFQUFFLElBQWlCO1lBQ3JFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2QixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUN0QixDQUFDO0lBRU8sUUFBUSxDQUFDLEtBQWtCO1FBQy9CLElBQUksWUFBWSxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQzNCLFdBQVcsQ0FBQztRQUNoQixPQUFPLFlBQVksS0FBSyxDQUFDLEVBQUU7WUFDdkIsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLFlBQVksQ0FBQyxDQUFDO1lBQ3ZELFlBQVksRUFBRSxDQUFDO1lBQ2YsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLEVBQUUsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7U0FDekY7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0NBQ0o7QUF6TEQsZ0NBeUxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGljZSB9IGZyb20gJy4vRGljZSc7XG5pbXBvcnQgeyBOb3RhdGlvbkNvZGVjIH0gZnJvbSAnLi9Ob3RhdGlvbkNvZGVjJztcblxuZXhwb3J0IGludGVyZmFjZSBJQ29sbGVjdGlvbiB7XG4gICAgc2V0IG1vZGlmaWVyKHZhbHVlOiBudW1iZXIpO1xuICAgIGdldCBtb2RpZmllcigpOiBudW1iZXI7XG4gICAgc2V0IG11bHRpcGxpZXIodmFsdWU6IG51bWJlcik7XG4gICAgZ2V0IG11bHRpcGxpZXIoKTogbnVtYmVyO1xuICAgIGdldCBzaWRlcygpOiBudW1iZXI7XG4gICAgZ2V0IGRpY2UoKTogQXJyYXk8RGljZT47XG4gICAgc2V0IGRpY2UodmFsdWU6IEFycmF5PERpY2U+KTtcbiAgICBnZXQgdmFsdWUoKTogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICAgIGdldCBib251cygpOiBudW1iZXI7XG4gICAgc2V0IGJvbnVzKHZhbHVlOiBudW1iZXIpO1xuICAgIGdldCB0b3RhbE5hdHVyYWwoKTogbnVtYmVyO1xuICAgIGdldCB0b3RhbCgpOiBudW1iZXI7XG4gICAgZ2V0IGV4Y2VzcygpOiBudW1iZXI7XG4gICAgZ2V0IG5vdGF0aW9uKCk6IHN0cmluZztcbiAgICBnZXQgbWluT3V0Y29tZSgpOiBudW1iZXI7XG4gICAgZ2V0IG1heE91dGNvbWUoKTogbnVtYmVyO1xuICAgIGdldCBtaW5Qb3RlbnRpYWwoKTogbnVtYmVyO1xuICAgIGdldCBtYXhQb3RlbnRpYWwoKTogbnVtYmVyO1xuICAgIGdldCBvdXRjb21lUGVyY2VudCgpOiBudW1iZXI7XG4gICAgY291bnQoKTogbnVtYmVyO1xuICAgIHJvbGwoKTogbnVtYmVyO1xuICAgIGFsbG9jYXRlQm9udXNlcyhhbW91bnQ6IG51bWJlcik6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBBIENvbGxlY3Rpb24gaG9sZHMgc2FtZSBzaWRlZCBEaWNlIGFuZCBjYW4gYmUgY29uZmlndXJlZCB0byBtb2RpZnkgb3IgbXVsdGlwbHkgdGhlIERpY2Ugb3V0Y29tZS5cbiAqL1xuZXhwb3J0IGNsYXNzIENvbGxlY3Rpb24gaW1wbGVtZW50cyBJQ29sbGVjdGlvbiB7XG4gICAgcHJpdmF0ZSBfZGljZTogQXJyYXk8RGljZT4gPSBbXTtcblxuICAgIHByaXZhdGUgX3NpZGVzOiBudW1iZXI7XG5cbiAgICBwcml2YXRlIF9tb2RpZmllcjogbnVtYmVyO1xuXG4gICAgcHJpdmF0ZSBfbXVsdGlwbGllcjogbnVtYmVyO1xuXG4gICAgLyoqIGV4Y2VzcyBib251cyBhbW91bnQgdGhhdCBjb3VsZCBub3QgYmUgYWJzb3JiZWQgYnkgZGljZSAqL1xuICAgIHByaXZhdGUgX2V4Y2VzczogbnVtYmVyO1xuXG4gICAgLy8gU2lkZXMgc2hvdWxkIGJlIGEgRGljZSBvYmplY3RcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoYW1vdW50OiBudW1iZXIsIHNpZGVzOiBudW1iZXIsIG1vZGlmaWVyOiBudW1iZXIgPSAwLCBtdWx0aXBsaWVyOiBudW1iZXIgPSAxKSB7XG4gICAgICAgIGlmIChhbW91bnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0EgY29sbGVjdGlvbiBtdXN0IGhhdmUgYXQgbGVhc3Qgb25lIGRpY2UuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBhbW91bnQ7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5fZGljZS5wdXNoKG5ldyBEaWNlKHNpZGVzKSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9zaWRlcyA9IHNpZGVzO1xuICAgICAgICB0aGlzLl9tb2RpZmllciA9IG1vZGlmaWVyO1xuICAgICAgICB0aGlzLl9tdWx0aXBsaWVyID0gbXVsdGlwbGllcjtcbiAgICAgICAgdGhpcy5fZXhjZXNzID0gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWxsb2NhdGVCb251c2VzKGFtb3VudDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgdGhpcy5fZGljZS5mb3JFYWNoKChkaWNlOiBEaWNlKSA9PiB7XG4gICAgICAgICAgICBhbW91bnQgPSBkaWNlLmFsbG9jYXRlQm9udXNlcyhhbW91bnQpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGFtb3VudDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0IG1vZGlmaWVyKHZhbHVlOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5fbW9kaWZpZXIgPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG1vZGlmaWVyKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9tb2RpZmllcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0IG11bHRpcGxpZXIodmFsdWU6IG51bWJlcikge1xuICAgICAgICB0aGlzLl9tdWx0aXBsaWVyID0gdmFsdWU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBtdWx0aXBsaWVyKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9tdWx0aXBsaWVyO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgc2lkZXMoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NpZGVzO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgZGljZSgpOiBBcnJheTxEaWNlPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kaWNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgZGljZSh2YWx1ZTogQXJyYXk8RGljZT4pIHtcbiAgICAgICAgdGhpcy5fZGljZSA9IHZhbHVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgdmFsdWUoKTogbnVtYmVyIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgbGV0IHZhbHVlID0gMDtcblxuICAgICAgICBmb3IgKGNvbnN0IGRpY2Ugb2YgdGhpcy5fZGljZSkge1xuICAgICAgICAgICAgaWYgKGRpY2UudmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFsdWUgKz0gZGljZS52YWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAodmFsdWUgKyB0aGlzLl9tb2RpZmllcikgKiB0aGlzLl9tdWx0aXBsaWVyO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgYm9udXMoKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IGJvbnVzID0gMDtcblxuICAgICAgICBmb3IgKGNvbnN0IGRpY2Ugb2YgdGhpcy5fZGljZSkge1xuICAgICAgICAgICAgaWYgKGRpY2UuYm9udXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYm9udXMgKz0gZGljZS5ib251cztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBib251cztcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0IGJvbnVzKHZhbHVlOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5fZGljZSA9IHRoaXMuX3NodWZmbGUodGhpcy5fZGljZSk7XG5cbiAgICAgICAgLy8gZG8gd2hpbGUgc2VlbXMgdG8gbWFrZSBtb3JlIHNlbnNlIGhlcmVcbiAgICAgICAgdGhpcy5fZGljZS5mb3JFYWNoKGZ1bmN0aW9uIChwYXJ0OiBEaWNlLCBpbmRleDogbnVtYmVyLCBkaWNlOiBBcnJheTxEaWNlPikge1xuICAgICAgICAgICAgaWYgKHZhbHVlID09PSAwKSB7XG4gICAgICAgICAgICAgICAgZGljZVtpbmRleF0uYm9udXMgPSAwO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZGljZVtpbmRleF0udmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBIGJvbnVzIGNhbm5vdCBvbmx5IGJlIGFwcGxpZWQgdG8gYSByb2xsZWQgZGljZS4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYm9udXMgPSBkaWNlW2luZGV4XS5tYXggLSAoZGljZVtpbmRleF0udmFsdWUgPz8gMCk7XG5cbiAgICAgICAgICAgIGRpY2VbaW5kZXhdLmJvbnVzID0gYm9udXM7XG5cbiAgICAgICAgICAgIGlmICh2YWx1ZSA+IGJvbnVzKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgLT0gYm9udXM7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fZXhjZXNzID0gdmFsdWU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCB0b3RhbE5hdHVyYWwoKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IHRvdGFsID0gMDtcblxuICAgICAgICB0aGlzLl9kaWNlLmZvckVhY2goZnVuY3Rpb24gKHBhcnQ6IERpY2UsIGluZGV4OiBudW1iZXIsIGRpY2U6IEFycmF5PERpY2U+KSB7XG4gICAgICAgICAgICB0b3RhbCArPSBkaWNlW2luZGV4XS50b3RhbDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRvdGFsO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgdG90YWwoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuICh0aGlzLnRvdGFsTmF0dXJhbCArIHRoaXMubW9kaWZpZXIpICogdGhpcy5tdWx0aXBsaWVyO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgZXhjZXNzKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9leGNlc3M7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBub3RhdGlvbigpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBub3RhdGlvbkNvZGVjID0gbmV3IE5vdGF0aW9uQ29kZWMoKTtcbiAgICAgICAgcmV0dXJuIG5vdGF0aW9uQ29kZWMuZW5jb2RlQ29sbGVjdGlvbih0aGlzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG1pbk91dGNvbWUoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY291bnQoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG1heE91dGNvbWUoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY291bnQoKSAqIHRoaXMuX3NpZGVzO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgbWluUG90ZW50aWFsKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiAodGhpcy5taW5PdXRjb21lICsgdGhpcy5tb2RpZmllcikgKiB0aGlzLm11bHRpcGxpZXI7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBtYXhQb3RlbnRpYWwoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuICh0aGlzLm1heE91dGNvbWUgKyB0aGlzLm1vZGlmaWVyKSAqIHRoaXMubXVsdGlwbGllcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG91dGNvbWVQZXJjZW50KCk6IG51bWJlciB7XG4gICAgICAgIGlmKHRoaXMudmFsdWUgPT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RpY2UgbXVzdCBiZSByb2xsZWQgYmVmb3JlIGFuIG91dGNvbWUgcGVyY2VudCBjYW4gYmUgY29tcHV0ZWQnKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiAodGhpcy52YWx1ZSAtIHRoaXMuY291bnQoKSkgLyAodGhpcy5tYXhPdXRjb21lIC0gdGhpcy5jb3VudCgpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RpY2UubGVuZ3RoO1xuICAgIH1cblxuICAgIHB1YmxpYyByb2xsKCk6IG51bWJlciB7XG4gICAgICAgIHRoaXMuX2RpY2UuZm9yRWFjaChmdW5jdGlvbiAocGFydDogRGljZSwgaW5kZXg6IG51bWJlciwgZGljZTogQXJyYXk8RGljZT4pIHtcbiAgICAgICAgICAgIGRpY2VbaW5kZXhdLnJvbGwoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMudG90YWw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2h1ZmZsZShhcnJheTogQXJyYXk8RGljZT4pOiBBcnJheTxEaWNlPntcbiAgICAgICAgbGV0IGN1cnJlbnRJbmRleCA9IGFycmF5Lmxlbmd0aCxcbiAgICAgICAgICAgIHJhbmRvbUluZGV4O1xuICAgICAgICB3aGlsZSAoY3VycmVudEluZGV4ICE9PSAwKSB7XG4gICAgICAgICAgICByYW5kb21JbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGN1cnJlbnRJbmRleCk7XG4gICAgICAgICAgICBjdXJyZW50SW5kZXgtLTtcbiAgICAgICAgICAgIFthcnJheVtjdXJyZW50SW5kZXhdLCBhcnJheVtyYW5kb21JbmRleF1dID0gW2FycmF5W3JhbmRvbUluZGV4XSwgYXJyYXlbY3VycmVudEluZGV4XV07XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYXJyYXk7XG4gICAgfVxufVxuIl19